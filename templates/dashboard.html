<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulation Center Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.18.0.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #64748b;
            --success-color: #10b981;
            --background-color: #f8fafc;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --navbar-color: #6a0dad; /* Purple color for the navbar */
        }

        body { 
            /* Added a subtle gradient background as the provided URL was not a direct image link */
            background: linear-gradient(to bottom right, #f8fafc, #eef2f5);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            color: #1e293b;
        }

        .navbar { 
            background: var(--navbar-color) !important;
            box-shadow: var(--card-shadow);
            border-bottom: 1px solid #e2e8f0;
        }

        .navbar-brand { 
            color: white !important; 
            font-weight: 700;
            font-size: 1.5rem;
        }

        .nav-link { 
            color: rgba(255, 255, 255, 0.7) !important;
            font-weight: 500;
            padding: 0.75rem 1rem !important;
            border-radius: 8px;
            margin: 0 0.25rem;
            transition: all 0.2s ease;
        }

        .nav-link:hover, .nav-link.active { 
            color: white !important;
            background-color: rgba(255, 255, 255, 0.1);
        }

        .section { 
            display: none; 
        }
        
        .active-section { 
            display: block; 
        }

        .card { 
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            margin-bottom: 1.5rem;
        }

        .card-header {
            background: white;
            border-bottom: 1px solid #e2e8f0;
            padding: 1.5rem;
            border-radius: 12px 12px 0 0 !important;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
            margin: 0;
        }

        .form-container {
            max-width: 600px;
            margin: 0 auto;
        }

        .form-label {
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .form-control, .form-select {
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 0.75rem;
            font-size: 0.95rem;
            transition: all 0.2s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .btn {
            font-weight: 500;
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: var(--primary-color);
            border: none;
        }

        .btn-primary:hover {
            background: #1d4ed8;
            transform: translateY(-1px);
        }

        .btn-success {
            background: var(--success-color);
            border: none;
        }

        .btn-success:hover {
            background: #059669;
            transform: translateY(-1px);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stats-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: var(--card-shadow);
            transition: transform 0.2s ease;
        }

        .stats-card:hover {
            transform: translateY(-2px);
        }

        .stats-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin: 0.5rem 0;
        }

        .stats-label {
            font-size: 0.9rem;
            color: var(--secondary-color);
            font-weight: 500;
        }

        .chart-container {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--card-shadow);
        }

        .upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: var(--primary-color);
            background-color: #eff6ff;
        }

        .upload-area.dragover {
            border-color: var(--primary-color);
            background-color: #eff6ff;
        }
        
        .upload-filename-wrapper {
            margin-top: 1rem;
            min-height: 24px; /* Ensure space is reserved when no file is selected */
        }
        
        .upload-filename {
            display: inline-block;
            font-weight: 500;
        }
        
        .upload-clear-btn {
            background: transparent;
            border: none;
            color: #dc2626;
            cursor: pointer;
        }
        
        .upload-clear-btn:hover {
            color: #b91c1c;
        }

        .table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--card-shadow);
        }

        .table {
            margin: 0;
        }

        .table th {
            background-color: #f8fafc;
            border-color: #e2e8f0;
            font-weight: 600;
            color: #374151;
        }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 2rem;
            color: var(--secondary-color);
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--secondary-color);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .section-header {
            background: white;
            padding: 2rem 0 1rem 0;
            margin-bottom: 2rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .section-title {
            font-size: 2rem;
            font-weight: 700;
            color: #1e293b;
            margin: 0;
        }

        .section-subtitle {
            color: var(--secondary-color);
            margin-top: 0.5rem;
            font-size: 1.1rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

       /* SP Fields styling - Updated for better visibility control */
.sp-fields {
    transition: all 0.3s ease;
    overflow: hidden;
}

.sp-fields.hidden {
    max-height: 0;
    margin-bottom: 0;
    opacity: 0;
    display: none; /* Completely hide when not needed */
}

.sp-fields.visible {
    max-height: 200px;
    opacity: 1;
    display: block; /* Show when needed */
    margin-bottom: 1.5rem;
}

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .navbar-brand {
                font-size: 1.2rem;
            }

            .nav-link {
                padding: 0.5rem 0.75rem !important;
                font-size: 0.9rem;
            }

            .section-title {
                font-size: 1.5rem;
            }

            .stats-number {
                font-size: 1.5rem;
            }

            .chart-container {
                padding: 1rem;
            }

            .card-header {
                padding: 1rem;
            }

            .form-container {
                padding: 0 1rem;
            }
        }

        @media (max-width: 576px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .navbar-nav {
                flex-direction: column;
            }

            .upload-area {
                padding: 1rem;
            }

            .btn {
                padding: 0.5rem 1rem;
                font-size: 0.9rem;
            }
        }

        .data-persistence-indicator {
            position: fixed;
            top: 70px;
            right: 20px;
            background: var(--success-color);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .data-persistence-indicator.show {
            opacity: 1;
        }

        .period-selector {
            background: #f8fafc;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .period-btn {
            background: white;
            border: 1px solid #d1d5db;
            color: var(--secondary-color);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            margin-right: 0.5rem;
            transition: all 0.2s ease;
        }

        .period-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .chart-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: var(--secondary-color);
        }

        /* Custom Multi-Select Dropdown */
        .multi-select-wrapper {
            position: relative;
        }

        .multi-select-dropdown {
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 0.75rem;
            font-size: 0.95rem;
            background: white;
            cursor: pointer;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .multi-select-dropdown:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
            outline: none;
        }

        .multi-select-placeholder {
            color: #6b7280;
        }

        .multi-select-values {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
        }

        .multi-select-tag {
            background: var(--primary-color);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .multi-select-tag .remove {
            cursor: pointer;
            font-weight: bold;
        }

        .multi-select-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #d1d5db;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .multi-select-option {
            padding: 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
        }

        .multi-select-option:hover {
            background: #f3f4f6;
        }

        .multi-select-option.selected {
            background: #eff6ff;
            color: var(--primary-color);
        }

        .multi-select-dropdown-icon {
            transition: transform 0.2s ease;
        }

        .multi-select-dropdown.open .multi-select-dropdown-icon {
            transform: rotate(180deg);
        }

        /* Search and Pagination Styles */
        .search-filters {
            background: #f8fafc;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .search-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 1rem;
            align-items: end;
        }

        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            border-top: 1px solid #e2e8f0;
            background: #f8fafc;
        }

        .pagination-info {
            font-size: 0.9rem;
            color: var(--secondary-color);
        }

        .pagination-controls {
            display: flex;
            gap: 0.5rem;
        }

        .pagination-btn {
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            background: white;
            color: var(--secondary-color);
            border-radius: 6px;
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .pagination-btn:hover {
            background: #f3f4f6;
            color: var(--primary-color);
            text-decoration: none;
        }

        .pagination-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .bulk-actions {
            background: #f8fafc;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: none;
        }

        .bulk-actions.show {
            display: block;
        }

        .select-all-checkbox {
            margin-right: 0.5rem;
        }

        .record-checkbox {
            margin-right: 0.5rem;
        }

        .error-message {
            color: #dc2626;
            background: #fef2f2;
            border: 1px solid #fecaca;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        
        /* Modal styles */
        .modal-content {
            border-radius: 12px;
        }

        .modal-header {
            border-bottom: 1px solid #e2e8f0;
            padding: 1.5rem;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            border-top: 1px solid #e2e8f0;
            padding: 1rem 1.5rem;
        }


        @media (max-width: 768px) {
            .search-row {
                grid-template-columns: 1fr;
            }
            
            .pagination-container {
                flex-direction: column;
                gap: 1rem;
            }

            .period-btn {
                margin-bottom: 0.5rem;
            }

            .bulk-actions .d-flex {
                flex-direction: column;
                gap: 1rem;
            }
        }
    </style>
</head>
<body>

    <div id="dataSavedIndicator" class="data-persistence-indicator">
        <i class="fas fa-check-circle"></i> Data automatically saved
    </div>

    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-hospital-symbol"></i> Maverick Family Nursing Simulation Center
            </a>
            <div class="navbar-nav ms-auto d-flex flex-row">
                <a class="nav-link active" href="#" onclick="showSection('dashboard')" data-section="dashboard">
                    <i class="fas fa-home"></i> Dashboard
                </a>
                <a class="nav-link" href="#" onclick="showSection('add-session')" data-section="add-session">
                    <i class="fas fa-plus"></i> Add Session
                </a>
                <a class="nav-link" href="#" onclick="showSection('sessions')" data-section="sessions">
                    <i class="fas fa-list"></i> Sessions
                </a>
                <a class="nav-link" href="#" onclick="showSection('analytics')" data-section="analytics">
                    <i class="fas fa-chart-bar"></i> Analytics
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        
        <div class="section active-section" id="dashboard">
            <div class="section-header">
                <h1 class="section-title">Dashboard</h1>
                <p class="section-subtitle">Overview of simulation center activities</p>
            </div>

            <div class="stats-grid" id="summaryStats">
                <div class="stats-card">
                    <i class="fas fa-calendar-check fa-2x" style="color: var(--primary-color);"></i>
                    <div class="stats-number" id="totalSessions">0</div>
                    <div class="stats-label">Total Sessions</div>
                </div>
                <div class="stats-card">
                    <i class="fas fa-users fa-2x" style="color: var(--success-color);"></i>
                    <div class="stats-number" id="totalParticipants">0</div>
                    <div class="stats-label">Total Participants</div>
                </div>
                <div class="stats-card">
                    <i class="fas fa-clock fa-2x" style="color: #f59e0b;"></i>
                    <div class="stats-number" id="totalContactHours">0</div>
                    <div class="stats-label">Contact Hours</div>
                </div>
                <div class="stats-card">
                    <i class="fas fa-door-open fa-2x" style="color: #8b5cf6;"></i>
                    <div class="stats-number" id="uniqueRooms">0</div>
                    <div class="stats-label">Active Rooms</div>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-8">
                    <div class="chart-container">
                        <h5 class="mb-3">Contact Hours Timeline</h5>
                        <div id="quickTimelineChart"></div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="chart-container">
                        <h5 class="mb-3">Room Utilization</h5>
                        <div id="quickRoomChart"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="section" id="add-session">
            <div class="section-header">
                <h1 class="section-title">Add New Session</h1>
                <p class="section-subtitle">Record a new simulation session</p>
            </div>

            <div class="form-container">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="fas fa-upload"></i> Bulk Upload
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="upload-area" onclick="document.getElementById('uploadFile').click()">
                            <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                            <h5 class="upload-text">Drop files here or click to upload</h5>
                            <div class="upload-filename-wrapper">
                                <span class="upload-filename" id="selectedFileName">No file selected</span>
                                <button type="button" class="upload-clear-btn" onclick="clearFileUpload()">&times;</button>
                            </div>
                            <p class="text-muted">Supports CSV and Excel files</p>
                            <input type="file" id="uploadFile" name="file" class="d-none" accept=".csv,.xlsx,.xls" onchange="displayFileName(this)">
                        </div>
                        <button type="button" class="btn btn-primary mt-3 w-100" onclick="uploadFile()">
                            <i class="fas fa-upload"></i> Upload File
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="fas fa-edit"></i> Manual Entry
                        </h5>
                    </div>
                    <div class="card-body">
                        <form action="/add_record" method="post" id="sessionForm">
                            
                            <div class="form-group">
                                <label class="form-label">Date (MM/DD/YY):</label>
                                <input type="date" name="Date" class="form-control" required>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Branch:</label>
                                    <select name="Branch" class="form-select" required>
                                        <option value="">Select Branch</option>
                                        <option value="Academic">Academic</option>
                                        <option value="Workforce">Workforce</option>
                                        <option value="Tour">Tour</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Operator:</label>
                                    <div class="multi-select-wrapper" id="operatorMultiSelect">
                                        <div class="multi-select-dropdown" tabindex="0" onclick="toggleMultiSelectOperator()">
                                            <div class="multi-select-content">
                                                <span class="multi-select-placeholder">Select Operators</span>
                                                <div class="multi-select-values" style="display: none;"></div>
                                            </div>
                                            <i class="fas fa-chevron-down multi-select-dropdown-icon"></i>
                                        </div>
                                        <div class="multi-select-options">
                                            <div class="multi-select-option" data-value="Erica Mathis">Erica Mathis</div>
                                            <div class="multi-select-option" data-value="Megan Dohm">Megan Dohm</div>
                                            <div class="multi-select-option" data-value="Stephanie Bracken">Stephanie Bracken</div>
                                            <div class="multi-select-option" data-value="Ritesh Janga">Ritesh Janga</div>
                                            <div class="multi-select-option" data-value="Srajan Jain">Srajan Jain</div>
                                            <div class="multi-select-option" data-value="Kate Glogowski">Kate Glogowski</div>
                                            <div class="multi-select-option" data-value="Austosh Basnet">Austosh Basnet</div>
                                            <div class="multi-select-option" data-value="Other">Other</div>
                                        </div>
                                    </div>
                                    <div id="hiddenOperatorInputs"></div>
                                    <small class="form-text text-muted">Click to select multiple operators</small>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Start Time:</label>
                                    <input type="time" name="Start_Time" class="form-control">
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Length (Hours):</label>
                                    <input type="number" name="Length_Hours" class="form-control" step="0.5" min="0" max="12" required>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Recording Name:</label>
                                <input type="text" name="Patient_Name" class="form-control" placeholder="e.g. Victor Maverick - Section 3">
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Room:</label>
                                    <select name="Room" class="form-select" required>
                                        <option value="">Select Room</option>
                                        <option value="Med-Surg 1">Med-Surg 1</option>
                                        <option value="Med-Surg 2">Med-Surg 2</option>
                                        <option value="Med-Surg 3">Med-Surg 3</option>
                                        <option value="Peds">Peds</option>
                                        <option value="OB">OB</option>
                                        <option value="Home Health">Home Health</option>
                                        <option value="OR">OR</option>
                                        <option value="Off site">Off site</option>
                                        <option value="SIM center">SIM center</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Debrief Location:</label>
                                    <select name="Debrief_Location" class="form-select">
                                        <option value="">Select Location</option>
                                        <option value="DB1">DB1</option>
                                        <option value="DB2">DB2</option>
                                        <option value="DB3">DB3</option>
                                        <option value="214">214</option>
                                        <option value="215">215</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Other Locations:</label>
                                <div class="multi-select-wrapper" id="locationMultiSelect">
                                    <div class="multi-select-dropdown" tabindex="0" onclick="toggleMultiSelectLocation()">
                                        <div class="multi-select-content">
                                            <span class="multi-select-placeholder">Select Locations</span>
                                            <div class="multi-select-values" style="display: none;"></div>
                                        </div>
                                        <i class="fas fa-chevron-down multi-select-dropdown-icon"></i>
                                    </div>
                                    <div class="multi-select-options">
                                        <div class="multi-select-option" data-value="Med room 1">Med room 1</div>
                                        <div class="multi-select-option" data-value="Med room 2">Med room 2</div>
                                        <div class="multi-select-option" data-value="MS1/MS2 Control">MS1/MS2 Control</div>
                                        <div class="multi-select-option" data-value="MS3/OR Control">MS3/OR Control</div>
                                        <div class="multi-select-option" data-value="HH/Peds/OB Control">HH/Peds/OB Control</div>
                                        <div class="multi-select-option" data-value="Other">Other</div>
                                    </div>
                                </div>
                                <div id="hiddenLocationInputs"></div>
                                <small class="form-text text-muted">Click to select multiple locations</small>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Manikin:</label>
                                <select name="Manikin" class="form-select">
                                    <option value="">Select Manikin</option>
                                    <option value="Adult Hal S5301">Adult Hal S5301</option>
                                    <option value="SimMan 10 - Light">SimMan 10 - Light</option>
                                    <option value="SimMan 15 - Light">SimMan 15 - Light</option>
                                    <option value="SimMan 16- Light">SimMan 16- Light</option>
                                    <option value="SimMan 17 - black">SimMan 17 - black</option>
                                    <option value="SimMan 22 - Tan">SimMan 22 - Tan</option>
                                    <option value="SimBaby - L">SimBaby - L</option>
                                    <option value="SimJunior - Tan">SimJunior - Tan</option>
                                    <option value="SimKid - L">SimKid - L</option>
                                    <option value="Pediatric Hal S 2225">Pediatric Hal S 2225</option>
                                    <option value="Birthing baby">Birthing baby</option>
                                    <option value="Newborn Tory">Newborn Tory</option>
                                    <option value="Super Tory">Super Tory</option>
                                    <option value="Preemie Anne">Preemie Anne</option>
                                    <option value="Victoria 1">Victoria 1</option>
                                    <option value="Victoria 2">Victoria 2</option>
                                    <option value="Nursing Anne (Black - Low fidelity)">Nursing Anne (Black - Low fidelity)</option>
                                    <option value="Nursing Anne Simulator - D">Nursing Anne Simulator - D</option>
                                    <option value="Nursing Anne Simulator - L">Nursing Anne Simulator - L</option>
                                    <option value="None">None</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Number of Participants:</label>
                                <input type="number" name="Participants" class="form-control" min="1" max="50" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label">SP Used:</label>
                                <select name="Simulated_Participants" class="form-select" id="spUsedSelect" onchange="toggleSPFields()">
                                    <option value="">Select Option</option>
                                    <option value="No">No</option>
                                    <option value="Yes">Yes</option>
                                </select>
                            </div>

                            <div class="sp-fields hidden" id="spFields" style="display: none;">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">SP Number:</label>
                                        <input type="number" name="Num_Simulated_Participants" class="form-control" min="0" max="10" value="0" id="spNumber">
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">SP Name:</label>
                                        <input type="text" name="SP_Name" class="form-control" placeholder="Enter SP name if applicable" id="spName">
                                    </div>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Department:</label>
                                    <select name="Department" class="form-select" required>
                                        <option value="">Select Department</option>
                                        <option value="Nursing - Undergraduate (PLP)">Nursing - Undergraduate (PLP)</option>
                                        <option value="Athletic Training">Athletic Training</option>
                                        <option value="Speech Hearing Rehab Sciences">Speech Hearing Rehab Sciences</option>
                                        <option value="Dental">Dental</option>
                                        <option value="Dietetics">Dietetics</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Nursing Course:</label>
                                    <select name="Course" class="form-select">
                                        <option value="">Select Course</option>
                                        <option value="NURS 317">NURS 317</option>
                                        <option value="NURS 334">NURS 334</option>
                                        <option value="NURS 336">NURS 336</option>
                                        <option value="NURS 364">NURS 364</option>
                                        <option value="NURS 365">NURS 365</option>
                                        <option value="NURS 433">NURS 433</option>
                                        <option value="NURS 435">NURS 435</option>
                                        <option value="NURS 436">NURS 436</option>
                                        <option value="NURS 464">NURS 464</option>
                                        <option value="NURS 466">NURS 466</option>
                                        <option value="OTHER">OTHER</option>
                                    </select>
                                </div>
                            </div>

                            <div class="d-grid gap-2 d-md-flex justify-content-md-between mt-4">
                                <button type="submit" class="btn btn-success btn-lg">
                                    <i class="fas fa-plus"></i> Add Session
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="clearForm()">
                                    <i class="fas fa-broom"></i> Clear Form
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="section" id="sessions">
            <div class="section-header">
                <h1 class="section-title">Session Records</h1>
                <p class="section-subtitle">View and manage all simulation sessions</p>
            </div>

            <div class="search-filters">
                <h6 class="mb-3">Search and Filter</h6>
                <div class="search-row">
                    <div class="form-group mb-0">
                        <label class="form-label">Start Date:</label>
                        <input type="date" id="startDate" class="form-control" onchange="applyFilters()">
                    </div>
                    <div class="form-group mb-0">
                        <label class="form-label">End Date:</label>
                        <input type="date" id="endDate" class="form-control" onchange="applyFilters()">
                    </div>
                    <div class="form-group mb-0">
                        <label class="form-label">Filter by Branch:</label>
                        <select id="searchBranch" class="form-select" onchange="applyFilters()">
                            <option value="">All Branches</option>
                            <option value="Academic">Academic</option>
                            <option value="Workforce">Workforce</option>
                            <option value="Tour">Tour</option>
                        </select>
                    </div>
                    <div class="form-group mb-0">
                        <button type="button" class="btn btn-outline-secondary" onclick="clearFilters()">
                            <i class="fas fa-times"></i> Clear
                        </button>
                    </div>
                </div>
            </div>

            <div class="bulk-actions" id="bulkActions">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <span id="selectedCountText">0 records selected</span>
                    </div>
                    <div>
                        <button type="button" class="btn btn-primary btn-sm me-2" onclick="bulkDownload()">
                            <i class="fas fa-download"></i> Download Selected
                        </button>
                        <button type="button" class="btn btn-danger btn-sm" onclick="bulkDelete()">
                            <i class="fas fa-trash"></i> Delete Selected
                        </button>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title">All Sessions</h5>
                    <a href="/download" class="btn btn-outline-primary">
                        <i class="fas fa-download"></i> Export All Excel
                    </a>
                </div>
                <div class="table-container">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>
                                        <input type="checkbox" class="select-all-checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
                                    </th>
                                    <th>#</th>
                                    <th>Date</th>
                                    <th>Branch</th>
                                    <th>Operator</th>
                                    <th>Room</th>
                                    <th>Participants</th>
                                    <th>Length</th>
                                    <th>Contact Hours</th>
                                    <th>Department</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="recordTable">
                                <tr>
                                    <td colspan="11" class="text-center py-4">
                                        <div class="loading-spinner" style="display: block;">
                                            <i class="fas fa-spinner fa-spin fa-2x"></i>
                                            <p class="mt-2">Loading sessions...</p>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="pagination-container">
                        <div class="pagination-info" id="paginationInfo">
                            Showing 0-0 of 0 records
                        </div>
                        <div class="pagination-controls" id="paginationControls">
                            </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="section" id="analytics">
            <div class="section-header">
                <h1 class="section-title">Analytics</h1>
                <p class="section-subtitle">Detailed insights and visualizations</p>
            </div>

            <div class="period-selector">
               <div class="d-flex align-items-center justify-content-between">
                   <div>
                       <h6 class="mb-2">Select Time Period:</h6>
                       <div class="period-buttons">
                           <button class="period-btn active" onclick="changePeriod('month')" data-period="month">
                               <i class="fas fa-calendar-alt"></i> Monthly
                           </button>
                           <button class="period-btn" onclick="changePeriod('week')" data-period="week">
                               <i class="fas fa-calendar-week"></i> Weekly
                           </button>
                           <button class="period-btn" onclick="changePeriod('quarter')" data-period="quarter">
                               <i class="fas fa-calendar"></i> Quarterly
                           </button>
                       </div>
                   </div>
                   <button class="btn btn-primary" onclick="refreshAnalytics()">
                       <i class="fas fa-sync-alt"></i> Refresh
                   </button>
               </div>
           </div>

           <div class="row">
               <div class="col-12 mb-4">
                   <div class="chart-container">
                       <h5 class="mb-3">Room Utilization Analysis</h5>
                       <div class="chart-loading" id="loading1">
                           <i class="fas fa-spinner fa-spin fa-2x"></i>
                           <span class="ms-2">Loading chart...</span>
                       </div>
                       <div id="roomUtilizationChart" style="display: none;"></div>
                   </div>
               </div>
           </div>

           <div class="row">
               <div class="col-lg-6 mb-4">
                   <div class="chart-container">
                       <h5 class="mb-3">Learner Statistics by <span id="periodLabel">Month</span></h5>
                       <div class="chart-loading" id="loading2">
                           <i class="fas fa-spinner fa-spin fa-2x"></i>
                           <span class="ms-2">Loading chart...</span>
                       </div>
                       <div id="learnerStatsChart" style="display: none;"></div>
                   </div>
               </div>
               <div class="col-lg-6 mb-4">
                   <div class="chart-container">
                       <h5 class="mb-3">Contact Hours Timeline</h5>
                       <div class="chart-loading" id="loading3">
                           <i class="fas fa-spinner fa-spin fa-2x"></i>
                           <span class="ms-2">Loading chart...</span>
                       </div>
                       <div id="contactHoursChart" style="display: none;"></div>
                   </div>
               </div>
           </div>

           <div class="row">
               <div class="col-12 mb-4">
                   <div class="chart-container">
                       <h5 class="mb-3">Contact Hours by Branch</h5>
                       <div class="chart-loading" id="loading4">
                           <i class="fas fa-spinner fa-spin fa-2x"></i>
                           <span class="ms-2">Loading chart...</span>
                       </div>
                       <div id="branchContactHoursChart" style="display: none;"></div>
                   </div>
               </div>
           </div>

           <div class="row">
                <div class="col-12 mb-4">
                    <div class="chart-container">
                        <h5 class="mb-3">Contact Hours vs. Session Hours by Branch</h5>
                        <div class="chart-loading" id="loading5">
                            <i class="fas fa-spinner fa-spin fa-2x"></i>
                            <span class="ms-2">Loading chart...</span>
                        </div>
                        <div id="branchHoursBreakdownChart" style="display: none;"></div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-12 mb-4">
                    <div class="chart-container">
                        <h5 class="mb-3">Contact Hours vs. Session Hours by Department</h5>
                        <div class="chart-loading" id="loading6">
                            <i class="fas fa-spinner fa-spin fa-2x"></i>
                            <span class="ms-2">Loading chart...</span>
                        </div>
                        <div id="departmentHoursBreakdownChart" style="display: none;"></div>
                    </div>
                </div>
            </div>
       </div>

   </div>

    <!-- Update Modal with Fixed Multi-Select -->
    <div class="modal fade" id="updateModal" tabindex="-1" aria-labelledby="updateModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form id="updateForm" action="/update_record" method="post">
                    <div class="modal-header">
                        <h5 class="modal-title" id="updateModalLabel">Update Record</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" name="update_index" id="update_index">
                        
                        <div class="form-group">
                            <label class="form-label">Date (MM/DD/YY):</label>
                            <input type="date" name="Date" class="form-control" id="updateDate" required>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Branch:</label>
                                <select name="Branch" class="form-select" id="updateBranch" required>
                                    <option value="">Select Branch</option>
                                    <option value="Academic">Academic</option>
                                    <option value="Workforce">Workforce</option>
                                    <option value="Tour">Tour</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Operator:</label>
                                <div class="multi-select-wrapper" id="updateOperatorMultiSelect">
                                    <div class="multi-select-dropdown" tabindex="0" onclick="toggleMultiSelectUpdateOperator()">
                                        <div class="multi-select-content">
                                            <span class="multi-select-placeholder">Select Operators</span>
                                            <div class="multi-select-values" style="display: none;"></div>
                                        </div>
                                        <i class="fas fa-chevron-down multi-select-dropdown-icon"></i>
                                    </div>
                                    <div class="multi-select-options">
                                        <div class="multi-select-option" data-value="Erica Mathis">Erica Mathis</div>
                                        <div class="multi-select-option" data-value="Megan Dohm">Megan Dohm</div>
                                        <div class="multi-select-option" data-value="Stephanie Bracken">Stephanie Bracken</div>
                                        <div class="multi-select-option" data-value="Ritesh Janga">Ritesh Janga</div>
                                        <div class="multi-select-option" data-value="Srajan Jain">Srajan Jain</div>
                                        <div class="multi-select-option" data-value="Kate Glogowski">Kate Glogowski</div>
                                        <div class="multi-select-option" data-value="Austosh Basnet">Austosh Basnet</div>
                                        <div class="multi-select-option" data-value="Other">Other</div>
                                    </div>
                                </div>
                                <div id="updateHiddenOperatorInputs"></div>
                                <small class="form-text text-muted">Click to select multiple operators</small>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Start Time:</label>
                                <input type="time" name="Start_Time" class="form-control" id="updateStart_Time">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Length (Hours):</label>
                                <input type="number" name="Length_Hours" class="form-control" step="0.5" min="0" max="12" id="updateLength_Hours" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Recording Name:</label>
                            <input type="text" name="Patient_Name" class="form-control" id="updatePatient_Name">
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Room:</label>
                                <select name="Room" class="form-select" id="updateRoom" required>
                                    <option value="">Select Room</option>
                                    <option value="Med-Surg 1">Med-Surg 1</option>
                                    <option value="Med-Surg 2">Med-Surg 2</option>
                                    <option value="Med-Surg 3">Med-Surg 3</option>
                                    <option value="Peds">Peds</option>
                                    <option value="OB">OB</option>
                                    <option value="Home Health">Home Health</option>
                                    <option value="OR">OR</option>
                                    <option value="Off site">Off site</option>
                                    <option value="SIM center">SIM center</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Debrief Location:</label>
                                <select name="Debrief_Location" class="form-select" id="updateDebrief_Location">
                                    <option value="">Select Location</option>
                                    <option value="DB1">DB1</option>
                                    <option value="DB2">DB2</option>
                                    <option value="DB3">DB3</option>
                                    <option value="214">214</option>
                                    <option value="215">215</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Other Locations:</label>
                            <div class="multi-select-wrapper" id="updateLocationMultiSelect">
                                <div class="multi-select-dropdown" tabindex="0" onclick="toggleMultiSelectUpdateLocation()">
                                    <div class="multi-select-content">
                                        <span class="multi-select-placeholder">Select Locations</span>
                                        <div class="multi-select-values" style="display: none;"></div>
                                    </div>
                                    <i class="fas fa-chevron-down multi-select-dropdown-icon"></i>
                                </div>
                                <div class="multi-select-options">
                                    <div class="multi-select-option" data-value="Med room 1">Med room 1</div>
                                    <div class="multi-select-option" data-value="Med room 2">Med room 2</div>
                                    <div class="multi-select-option" data-value="MS1/MS2 Control">MS1/MS2 Control</div>
                                    <div class="multi-select-option" data-value="MS3/OR Control">MS3/OR Control</div>
                                    <div class="multi-select-option" data-value="HH/Peds/OB Control">HH/Peds/OB Control</div>
                                    <div class="multi-select-option" data-value="Other">Other</div>
                                </div>
                            </div>
                            <div id="updateHiddenLocationInputs"></div>
                            <small class="form-text text-muted">Click to select multiple locations</small>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Manikin:</label>
                            <select name="Manikin" class="form-select" id="updateManikin">
                                <option value="">Select Manikin</option>
                                <option value="Adult Hal S5301">Adult Hal S5301</option>
                                <option value="SimMan 10 - Light">SimMan 10 - Light</option>
                                <option value="SimMan 15 - Light">SimMan 15 - Light</option>
                                <option value="SimMan 16- Light">SimMan 16- Light</option>
                                <option value="SimMan 17 - black">SimMan 17 - black</option>
                                <option value="SimMan 22 - Tan">SimMan 22 - Tan</option>
                                <option value="SimBaby - L">SimBaby - L</option>
                                <option value="SimJunior - Tan">SimJunior - Tan</option>
                                <option value="SimKid - L">SimKid - L</option>
                                <option value="Pediatric Hal S 2225">Pediatric Hal S 2225</option>
                                <option value="Birthing baby">Birthing baby</option>
                                <option value="Newborn Tory">Newborn Tory</option>
                                <option value="Super Tory">Super Tory</option>
                                <option value="Preemie Anne">Preemie Anne</option>
                                <option value="Victoria 1">Victoria 1</option>
                                <option value="Victoria 2">Victoria 2</option>
                                <option value="Nursing Anne (Black - Low fidelity)">Nursing Anne (Black - Low fidelity)</option>
                                <option value="Nursing Anne Simulator - D">Nursing Anne Simulator - D</option>
                                <option value="Nursing Anne Simulator - L">Nursing Anne Simulator - L</option>
                                <option value="None">None</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Number of Participants:</label>
                            <input type="number" name="Participants" class="form-control" min="1" max="50" id="updateParticipants" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">SP Used:</label>
                            <select name="Simulated_Participants" class="form-select" id="updateSpUsedSelect" onchange="toggleSPFieldsUpdate()">
                                <option value="">Select Option</option>
                                <option value="No">No</option>
                                <option value="Yes">Yes</option>
                            </select>
                        </div>
                        
                        <div class="sp-fields hidden" id="updateSpFields" style="display: none;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">SP Number:</label>
                                    <input type="number" name="Num_Simulated_Participants" class="form-control" min="0" max="10" value="0" id="updateSpNumber">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">SP Name:</label>
                                    <input type="text" name="SP_Name" class="form-control" placeholder="Enter SP name if applicable" id="updateSpName">
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Department:</label>
                                <select name="Department" class="form-select" id="updateDepartment" required>
                                    <option value="">Select Department</option>
                                    <option value="Nursing - Undergraduate (PLP)">Nursing - Undergraduate (PLP)</option>
                                    <option value="Athletic Training">Athletic Training</option>
                                    <option value="Speech Hearing Rehab Sciences">Speech Hearing Rehab Sciences</option>
                                    <option value="Dental">Dental</option>
                                    <option value="Dietetics">Dietetics</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Nursing Course:</label>
                                <select name="Course" class="form-select" id="updateCourse">
                                    <option value="">Select Course</option>
                                    <option value="NURS 317">NURS 317</option>
                                    <option value="NURS 334">NURS 334</option>
                                    <option value="NURS 336">NURS 336</option>
                                    <option value="NURS 364">NURS 364</option>
                                    <option value="NURS 365">NURS 365</option>
                                    <option value="NURS 433">NURS 433</option>
                                    <option value="NURS 435">NURS 435</option>
                                    <option value="NURS 436">NURS 436</option>
                                    <option value="NURS 464">NURS 464</option>
                                    <option value="NURS 466">NURS 466</option>
                                    <option value="OTHER">OTHER</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
      // Global variables
let currentPeriod = 'month';
let selectedLocations = [];
let selectedOperators = [];
let updateSelectedLocations = [];
let updateSelectedOperators = [];
let currentPage = 1;
let selectedRecords = [];
let allRecordsCache = [];
let currentFilters = {
    startDate: '',
    endDate: '',
    branch: ''
};
let updateModal = null;

function toggleSPFields() {
    const spUsedSelect = document.getElementById('spUsedSelect');
    const spFields = document.getElementById('spFields');
    const spNumber = document.getElementById('spNumber');
    const spName = document.getElementById('spName');
    
    if (spUsedSelect.value === 'Yes') {
        spFields.classList.remove('hidden');
        spFields.classList.add('visible');
        spFields.style.display = 'block';
        if (!spNumber.value || spNumber.value === '0') {
            spNumber.value = '1';
        }
    } else {
        spFields.classList.remove('visible');
        spFields.classList.add('hidden');
        spFields.style.display = 'none';
        spNumber.value = '0';
        spName.value = '';
    }
}

function toggleSPFieldsUpdate() {
    const spUsedSelect = document.getElementById('updateSpUsedSelect');
    const spFields = document.getElementById('updateSpFields');
    const spNumber = document.getElementById('updateSpNumber');
    const spName = document.getElementById('updateSpName');
    
    if (spUsedSelect.value === 'Yes') {
        spFields.classList.remove('hidden');
        spFields.classList.add('visible');
        spFields.style.display = 'block';
        if (!spNumber.value || spNumber.value === '0') {
            spNumber.value = '1';
        }
    } else {
        spFields.classList.remove('visible');
        spFields.classList.add('hidden');
        spFields.style.display = 'none';
        spNumber.value = '0';
        spName.value = '';
    }
}

// Multi-select functions for the main form
function toggleMultiSelectLocation() {
    const dropdown = document.querySelector('#locationMultiSelect .multi-select-dropdown');
    const options = document.querySelector('#locationMultiSelect .multi-select-options');
    dropdown.classList.toggle('open');
    options.style.display = dropdown.classList.contains('open') ? 'block' : 'none';
}

function toggleMultiSelectOperator() {
    const dropdown = document.querySelector('#operatorMultiSelect .multi-select-dropdown');
    const options = document.querySelector('#operatorMultiSelect .multi-select-options');
    dropdown.classList.toggle('open');
    options.style.display = dropdown.classList.contains('open') ? 'block' : 'none';
}

// Multi-select functions for the update modal
function toggleMultiSelectUpdateLocation() {
    const dropdown = document.querySelector('#updateLocationMultiSelect .multi-select-dropdown');
    const options = document.querySelector('#updateLocationMultiSelect .multi-select-options');
    dropdown.classList.toggle('open');
    options.style.display = dropdown.classList.contains('open') ? 'block' : 'none';
}

function toggleMultiSelectUpdateOperator() {
    const dropdown = document.querySelector('#updateOperatorMultiSelect .multi-select-dropdown');
    const options = document.querySelector('#updateOperatorMultiSelect .multi-select-options');
    dropdown.classList.toggle('open');
    options.style.display = dropdown.classList.contains('open') ? 'block' : 'none';
}

// Update functions for multi-select state management
function updateMultiSelectState(wrapperId, selectedValues, updateHiddenInputsFunc) {
    const wrapper = document.getElementById(wrapperId);
    if (!wrapper) return;
    
    const placeholder = wrapper.querySelector('.multi-select-placeholder');
    const valuesContainer = wrapper.querySelector('.multi-select-values');

    if (selectedValues.length === 0) {
        placeholder.style.display = 'block';
        valuesContainer.style.display = 'none';
    } else {
        placeholder.style.display = 'none';
        valuesContainer.style.display = 'flex';
        valuesContainer.innerHTML = selectedValues.map(value => 
            `<span class="multi-select-tag">
                ${value}
                <span class="remove" onclick="removeMultiValue('${wrapperId}', '${value}')">&times;</span>
            </span>`
        ).join('');
    }

    wrapper.querySelectorAll('.multi-select-option').forEach(option => {
        const value = option.getAttribute('data-value');
        if (selectedValues.includes(value)) {
            option.classList.add('selected');
        } else {
            option.classList.remove('selected');
        }
    });

    updateHiddenInputsFunc(selectedValues, wrapperId);
}

function updateMultiSelectDisplayLocation() {
    updateMultiSelectState('locationMultiSelect', selectedLocations, updateHiddenInputsLocation);
}

function updateMultiSelectDisplayOperator() {
    updateMultiSelectState('operatorMultiSelect', selectedOperators, updateHiddenInputsOperator);
}

function updateMultiSelectUpdateLocationDisplay() {
    updateMultiSelectState('updateLocationMultiSelect', updateSelectedLocations, updateHiddenInputsUpdateLocation);
}

function updateMultiSelectUpdateOperatorDisplay() {
    updateMultiSelectState('updateOperatorMultiSelect', updateSelectedOperators, updateHiddenInputsUpdateOperator);
}

// Select option functions
function selectMultiOptionLocation(value) {
    if (selectedLocations.includes(value)) {
        selectedLocations = selectedLocations.filter(loc => loc !== value);
    } else {
        selectedLocations.push(value);
    }
    updateMultiSelectDisplayLocation();
}

function selectMultiOptionOperator(value) {
    if (selectedOperators.includes(value)) {
        selectedOperators = selectedOperators.filter(op => op !== value);
    } else {
        selectedOperators.push(value);
    }
    updateMultiSelectDisplayOperator();
}

function selectMultiOptionUpdateLocation(value) {
    if (updateSelectedLocations.includes(value)) {
        updateSelectedLocations = updateSelectedLocations.filter(loc => loc !== value);
    } else {
        updateSelectedLocations.push(value);
    }
    updateMultiSelectUpdateLocationDisplay();
}

function selectMultiOptionUpdateOperator(value) {
    if (updateSelectedOperators.includes(value)) {
        updateSelectedOperators = updateSelectedOperators.filter(op => op !== value);
    } else {
        updateSelectedOperators.push(value);
    }
    updateMultiSelectUpdateOperatorDisplay();
}

// Remove value functions
function removeMultiValue(wrapperId, value) {
    if (wrapperId === 'locationMultiSelect') {
        selectedLocations = selectedLocations.filter(loc => loc !== value);
        updateMultiSelectDisplayLocation();
    } else if (wrapperId === 'operatorMultiSelect') {
        selectedOperators = selectedOperators.filter(op => op !== value);
        updateMultiSelectDisplayOperator();
    } else if (wrapperId === 'updateLocationMultiSelect') {
        updateSelectedLocations = updateSelectedLocations.filter(loc => loc !== value);
        updateMultiSelectUpdateLocationDisplay();
    } else if (wrapperId === 'updateOperatorMultiSelect') {
        updateSelectedOperators = updateSelectedOperators.filter(op => op !== value);
        updateMultiSelectUpdateOperatorDisplay();
    }
}

// Hidden input update functions
function updateHiddenInputsLocation() {
    const container = document.getElementById('hiddenLocationInputs');
    container.innerHTML = selectedLocations.map(location => 
        `<input type="hidden" name="Other_Locations" value="${location}">`
    ).join('');
}

function updateHiddenInputsOperator() {
    const container = document.getElementById('hiddenOperatorInputs');
    container.innerHTML = selectedOperators.map(operator => 
        `<input type="hidden" name="Operator" value="${operator}">`
    ).join('');
}

function updateHiddenInputsUpdateLocation(locations, containerId) {
    const container = document.getElementById('updateHiddenLocationInputs');
    container.innerHTML = locations.map(location =>
        `<input type="hidden" name="Other_Locations" value="${location}">`
    ).join('');
}

function updateHiddenInputsUpdateOperator(operators, containerId) {
    const container = document.getElementById('updateHiddenOperatorInputs');
    container.innerHTML = operators.map(operator =>
        `<input type="hidden" name="Operator" value="${operator}">`
    ).join('');
}

function clearForm() {
    document.getElementById('sessionForm').reset();
    selectedLocations = [];
    selectedOperators = [];
    updateMultiSelectDisplayLocation();
    updateMultiSelectDisplayOperator();
    updateHiddenInputsLocation();
    updateHiddenInputsOperator();
    
    const spFields = document.getElementById('spFields');
    const spNumber = document.getElementById('spNumber');
    const spName = document.getElementById('spName');
    
    spFields.classList.remove('visible');
    spFields.classList.add('hidden');
    spFields.style.display = 'none';
    spNumber.value = '0';
    spName.value = '';
}

function displayFileName(input) {
    const fileName = input.files[0] ? input.files[0].name : 'No file selected';
    document.getElementById('selectedFileName').textContent = fileName;
}

function clearFileUpload() {
    document.getElementById('uploadFile').value = '';
    document.getElementById('selectedFileName').textContent = 'No file selected';
}

function uploadFile() {
    const fileInput = document.getElementById('uploadFile');
    if (!fileInput.files[0]) {
        alert('Please select a file first.');
        return;
    }

    const formData = new FormData();
    formData.append('file', fileInput.files[0]);

    fetch('/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            alert(data.message + '\nRows added: ' + data.rows_added);
            clearFileUpload();
            showDataSavedIndicator();
            loadSummaryStats();
            fetchRecords();
        }
    })
    .catch(error => {
        console.error('Upload error:', error);
        alert('Error uploading file: ' + error.message);
    });
}

function showDataSavedIndicator() {
    const indicator = document.getElementById('dataSavedIndicator');
    indicator.classList.add('show');
    setTimeout(() => {
        indicator.classList.remove('show');
    }, 3000);
}

document.addEventListener('DOMContentLoaded', function() {
    console.log('Dashboard loaded');
    
    updateModal = new bootstrap.Modal(document.getElementById('updateModal'), {});
    
    // Setup main form multi-select event listeners
    document.querySelectorAll('#locationMultiSelect .multi-select-option').forEach(option => {
        option.addEventListener('click', function() {
            const value = this.getAttribute('data-value');
            selectMultiOptionLocation(value);
        });
    });
    
    document.querySelectorAll('#operatorMultiSelect .multi-select-option').forEach(option => {
        option.addEventListener('click', function() {
            const value = this.getAttribute('data-value');
            selectMultiOptionOperator(value);
        });
    });

    // Setup update modal multi-select event listeners
    document.querySelectorAll('#updateLocationMultiSelect .multi-select-option').forEach(option => {
        option.addEventListener('click', function() {
            const value = this.getAttribute('data-value');
            selectMultiOptionUpdateLocation(value);
        });
    });

    document.querySelectorAll('#updateOperatorMultiSelect .multi-select-option').forEach(option => {
        option.addEventListener('click', function() {
            const value = this.getAttribute('data-value');
            selectMultiOptionUpdateOperator(value);
        });
    });
    
    // Close dropdowns when clicking outside
    document.addEventListener('click', function(event) {
        if (!event.target.closest('.multi-select-wrapper')) {
            document.querySelectorAll('.multi-select-dropdown').forEach(dropdown => {
                dropdown.classList.remove('open');
                dropdown.nextElementSibling.style.display = 'none';
            });
        }
    });
    
    setupFormValidation();
    setupDragAndDrop();
    loadDashboard();
});

function showSection(sectionId) {
    document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
    });
    
    const clickedLink = document.querySelector(`[data-section="${sectionId}"]`);
    if (clickedLink) {
        clickedLink.classList.add('active');
    }

    document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active-section');
    });
    document.getElementById(sectionId).classList.add('active-section');

    switch(sectionId) {
        case 'dashboard':
            loadDashboard();
            break;
        case 'sessions':
            resetFiltersAndPagination();
            fetchAllRecords().then(() => fetchRecords());
            break;
        case 'analytics':
            loadAnalytics();
            break;
    }
}

function loadDashboard() {
    loadSummaryStats();
    loadQuickCharts();
}

function loadSummaryStats() {
    fetch('/api/summary_stats')
    .then(response => response.json())
    .then(data => {
        document.getElementById('totalSessions').textContent = formatNumber(data.total_sessions);
        document.getElementById('totalParticipants').textContent = formatNumber(data.total_participants);
        document.getElementById('totalContactHours').textContent = formatNumber(Math.round(data.total_contact_hours));
        document.getElementById('uniqueRooms').textContent = formatNumber(data.unique_rooms);
    })
    .catch(error => {
        console.error('Error loading summary stats:', error);
    });
}

function loadQuickCharts() {
    fetch('/api/contact_hours_timeline')
    .then(response => response.json())
    .then(data => {
        if (data.graph) {
            const graphData = JSON.parse(data.graph);
            Plotly.newPlot('quickTimelineChart', graphData.data, graphData.layout, {responsive: true});
        }
    })
    .catch(error => console.error('Error loading timeline chart:', error));

    fetch('/api/room_utilization')
    .then(response => response.json())
    .then(data => {
        if (data.graph) {
            const graphData = JSON.parse(data.graph);
            Plotly.newPlot('quickRoomChart', graphData.data, graphData.layout, {responsive: true});
        }
    })
    .catch(error => console.error('Error loading room chart:', error));
}

function loadAnalytics() {
    loadAllAnalyticsCharts();
}

function loadAllAnalyticsCharts() {
    const charts = [
        { endpoint: '/api/room_utilization', elementId: 'roomUtilizationChart', loadingId: 'loading1' },
        { endpoint: '/api/learner_stats?period=' + currentPeriod, elementId: 'learnerStatsChart', loadingId: 'loading2' },
        { endpoint: '/api/contact_hours_timeline', elementId: 'contactHoursChart', loadingId: 'loading3' },
        { endpoint: '/api/branch_contact_hours', elementId: 'branchContactHoursChart', loadingId: 'loading4' },
        { endpoint: '/api/branch_hours_breakdown', elementId: 'branchHoursBreakdownChart', loadingId: 'loading5' },
        { endpoint: '/api/department_hours_breakdown', elementId: 'departmentHoursBreakdownChart', loadingId: 'loading6' }
    ];

    charts.forEach(chart => {
        const loadingElement = document.getElementById(chart.loadingId);
        const chartElement = document.getElementById(chart.elementId);
        
        if (loadingElement) loadingElement.style.display = 'flex';
        if (chartElement) chartElement.style.display = 'none';

        fetch(chart.endpoint)
        .then(response => response.json())
        .then(data => {
            if (loadingElement) loadingElement.style.display = 'none';
            
            if (data.graph) {
                const graphData = JSON.parse(data.graph);
                if (chartElement) {
                    chartElement.style.display = 'block';
                    Plotly.newPlot(chart.elementId, graphData.data, graphData.layout, {responsive: true});
                }
            } else if (chartElement) {
                chartElement.innerHTML = '<p class="text-center text-muted py-4">No data available</p>';
                chartElement.style.display = 'block';
            }
        })
        .catch(error => {
            console.error(`Error loading ${chart.elementId}:`, error);
            if (loadingElement) loadingElement.style.display = 'none';
            if (chartElement) {
                chartElement.innerHTML = '<p class="text-center text-danger py-4">Error loading chart</p>';
                chartElement.style.display = 'block';
            }
        });
    });
}

function changePeriod(period) {
    currentPeriod = period;
    
    document.querySelectorAll('.period-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[data-period="${period}"]`).classList.add('active');
    
    document.getElementById('periodLabel').textContent = period.charAt(0).toUpperCase() + period.slice(1);
    
    const loadingElement = document.getElementById('loading2');
    const chartElement = document.getElementById('learnerStatsChart');
    
    if (loadingElement) loadingElement.style.display = 'flex';
    if (chartElement) chartElement.style.display = 'none';

    fetch(`/api/learner_stats?period=${period}`)
    .then(response => response.json())
    .then(data => {
        if (loadingElement) loadingElement.style.display = 'none';
        
        if (data.graph) {
            const graphData = JSON.parse(data.graph);
            if (chartElement) {
                chartElement.style.display = 'block';
                Plotly.newPlot('learnerStatsChart', graphData.data, graphData.layout, {responsive: true});
            }
        }
    })
    .catch(error => {
        console.error('Error loading learner stats:', error);
        if (loadingElement) loadingElement.style.display = 'none';
        if (chartElement) {
            chartElement.innerHTML = '<p class="text-center text-danger py-4">Error loading chart</p>';
            chartElement.style.display = 'block';
        }
    });
}

function refreshAnalytics() {
    loadAllAnalyticsCharts();
}

function fetchRecords() {
    const params = new URLSearchParams({
        page: currentPage,
        per_page: 10,
        start_date: currentFilters.startDate,
        end_date: currentFilters.endDate,
        search_branch: currentFilters.branch
    });

    fetch(`/records?${params}`)
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showErrorMessage('Error loading records: ' + data.error);
            return;
        }
        
        displayRecords(data.records);
        updatePagination(data.pagination);
    })
    .catch(error => {
        console.error('Error fetching records:', error);
        showErrorMessage('Error loading records: ' + error.message);
    });
}

function displayRecords(records) {
    const tableBody = document.getElementById('recordTable');
    
    if (!records || records.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="11" class="text-center py-4">
                    <div class="empty-state">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <p>No records found</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }

    tableBody.innerHTML = records.map((record, index) => `
        <tr data-id="${record.id}">
            <td>
                <input type="checkbox" class="record-checkbox" 
                       onchange="toggleRecordSelection(this, '${record.id}')"
                       ${selectedRecords.includes(record.id.toString()) ? 'checked' : ''}>
            </td>
            <td>${record.id}</td>
            <td>${formatDate(record.Date)}</td>
            <td><span class="badge bg-primary">${record.Branch || ''}</span></td>
            <td>${record.Operator || ''}</td>
            <td>${record.Room || ''}</td>
            <td>${record.Participants || 0}</td>
            <td>${record.Length_Hours || 0}h</td>
            <td>${Math.round(record.Contact_Hours || 0)}</td>
            <td>${record.Department || ''}</td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-secondary btn-sm" 
                            onclick="editRecord(${record.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-outline-danger btn-sm" 
                            onclick="deleteRecord(${record.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

function deleteRecord(recordId) {
    if (!confirm('Are you sure you want to delete this record?')) {
        return;
    }

    const formData = new FormData();
    formData.append('index', recordId);

    fetch('/delete_record', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.redirected) {
            showDataSavedIndicator();
            loadSummaryStats();
            fetchAllRecords().then(() => fetchRecords());
        } else {
            return response.json();
        }
    })
    .then(data => {
        if (data && data.error) {
            showErrorMessage('Error deleting record: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Delete error:', error);
        showErrorMessage('Error deleting record: ' + error.message);
    });
}

function editRecord(recordId) {
    if (allRecordsCache.length === 0) {
        showErrorMessage('Error: Record data is still loading. Please try again in a moment.');
        return;
    }
    const recordToEdit = allRecordsCache.find(r => r.id === recordId);
    if (!recordToEdit) {
        showErrorMessage('Error: Record not found.');
        return;
    }

    // Reset the multi-select arrays for update
    updateSelectedLocations = [];
    updateSelectedOperators = [];

    document.getElementById('update_index').value = recordId;
    document.getElementById('updateDate').value = recordToEdit.Date || '';
    document.getElementById('updateBranch').value = recordToEdit.Branch || '';
    document.getElementById('updateStart_Time').value = recordToEdit.Start_Time || '';
    document.getElementById('updateLength_Hours').value = recordToEdit.Length_Hours || 0;
    document.getElementById('updatePatient_Name').value = recordToEdit.Patient_Name || '';
    document.getElementById('updateRoom').value = recordToEdit.Room || '';
    document.getElementById('updateDebrief_Location').value = recordToEdit.Debrief_Location || '';
    document.getElementById('updateManikin').value = recordToEdit.Manikin || '';
    document.getElementById('updateParticipants').value = recordToEdit.Participants || 0;
    document.getElementById('updateSpUsedSelect').value = recordToEdit.Simulated_Participants || 'No';
    document.getElementById('updateSpNumber').value = recordToEdit.Num_Simulated_Participants || 0;
    document.getElementById('updateSpName').value = recordToEdit.SP_Name || '';
    document.getElementById('updateDepartment').value = recordToEdit.Department || '';
    document.getElementById('updateCourse').value = recordToEdit.Course || '';

    // Handle multi-selects for update form
    if (recordToEdit.Other_Locations) {
        updateSelectedLocations = recordToEdit.Other_Locations.split(',').map(s => s.trim()).filter(s => s);
    }
    if (recordToEdit.Operator) {
        updateSelectedOperators = recordToEdit.Operator.split(',').map(s => s.trim()).filter(s => s);
    }
    
    updateMultiSelectUpdateLocationDisplay();
    updateMultiSelectUpdateOperatorDisplay();
    toggleSPFieldsUpdate();

    updateModal.show();
}

function applyFilters() {
    currentFilters.startDate = document.getElementById('startDate').value;
    currentFilters.endDate = document.getElementById('endDate').value;
    currentFilters.branch = document.getElementById('searchBranch').value;
    currentPage = 1;
    fetchRecords();
}

function clearFilters() {
    document.getElementById('startDate').value = '';
    document.getElementById('endDate').value = '';
    document.getElementById('searchBranch').value = '';
    currentFilters.startDate = '';
    currentFilters.endDate = '';
    currentFilters.branch = '';
    currentPage = 1;
    fetchRecords();
}

function resetFiltersAndPagination() {
    currentPage = 1;
    selectedRecords = [];
    currentFilters = { startDate: '', endDate: '', branch: '' };
    document.getElementById('startDate').value = '';
    document.getElementById('endDate').value = '';
    document.getElementById('searchBranch').value = '';
    updateBulkActionsVisibility();
}

function fetchAllRecords() {
    return fetch('/records?page=1&per_page=10000')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.error) {
                throw new Error(data.message || data.error);
            }
            allRecordsCache = data.records || [];
            return allRecordsCache;
        })
        .catch(error => {
            console.error('Error fetching all records:', error);
            showErrorMessage('Error loading records: ' + error.message);
            return [];
        });
}

function goToPage(page) {
    currentPage = page;
    fetchRecords();
}

function updatePagination(paginationData) {
    const paginationInfo = document.getElementById('paginationInfo');
    const paginationControls = document.getElementById('paginationControls');
    
    paginationInfo.textContent = `Showing ${paginationData.start_record}-${paginationData.end_record} of ${paginationData.total_records} records`;
    
    let controlsHtml = '';
    
    if (paginationData.has_prev) {
        controlsHtml += `<button class="pagination-btn" onclick="goToPage(${paginationData.page - 1})">
            <i class="fas fa-chevron-left"></i> Previous
        </button>`;
    } else {
        controlsHtml += `<button class="pagination-btn" disabled>
            <i class="fas fa-chevron-left"></i> Previous
        </button>`;
    }
    
    const startPage = Math.max(1, paginationData.page - 2);
    const endPage = Math.min(paginationData.total_pages, paginationData.page + 2);
    
    for (let i = startPage; i <= endPage; i++) {
        if (i === paginationData.page) {
            controlsHtml += `<button class="pagination-btn active" onclick="goToPage(${i})">${i}</button>`;
        } else {
            controlsHtml += `<button class="pagination-btn" onclick="goToPage(${i})">${i}</button>`;
        }
    }
    
    if (paginationData.has_next) {
        controlsHtml += `<button class="pagination-btn" onclick="goToPage(${paginationData.page + 1})">
            Next <i class="fas fa-chevron-right"></i>
        </button>`;
    } else {
        controlsHtml += `<button class="pagination-btn" disabled>
            Next <i class="fas fa-chevron-right"></i>
        </button>`;
    }
    
    paginationControls.innerHTML = controlsHtml;
}

function toggleSelectAll() {
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    const recordCheckboxes = document.querySelectorAll('.record-checkbox');
    
    selectedRecords = [];
    
    recordCheckboxes.forEach((checkbox) => {
        checkbox.checked = selectAllCheckbox.checked;
        if (selectAllCheckbox.checked) {
            const recordId = checkbox.closest('tr').getAttribute('data-id');
            selectedRecords.push(recordId);
        }
    });
    
    updateBulkActionsVisibility();
}

function toggleRecordSelection(checkbox, recordId) {
    if (checkbox.checked) {
        if (!selectedRecords.includes(recordId)) {
            selectedRecords.push(recordId);
        }
    } else {
        selectedRecords = selectedRecords.filter(id => id !== recordId);
    }
    
    updateSelectAllCheckbox();
    updateBulkActionsVisibility();
}

function updateSelectAllCheckbox() {
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    const recordCheckboxes = document.querySelectorAll('.record-checkbox');
    const checkedCount = Array.from(recordCheckboxes).filter(cb => cb.checked).length;
    
    selectAllCheckbox.checked = checkedCount === recordCheckboxes.length && recordCheckboxes.length > 0;
    selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < recordCheckboxes.length;
}

function updateBulkActionsVisibility() {
    const bulkActions = document.getElementById('bulkActions');
    const selectedCountText = document.getElementById('selectedCountText');
    
    if (selectedRecords.length > 0) {
        bulkActions.classList.add('show');
        selectedCountText.textContent = `${selectedRecords.length} record${selectedRecords.length !== 1 ? 's' : ''} selected`;
    } else {
        bulkActions.classList.remove('show');
    }
}

function showErrorMessage(message) {
    const existingErrors = document.querySelectorAll('.error-message');
    existingErrors.forEach(error => error.remove());
    
    const errorDiv = document.createElement('div');
    errorDiv.className = 'error-message';
    errorDiv.innerHTML = `
        <i class="fas fa-exclamation-triangle"></i>
        <strong>Error:</strong> ${message}
    `;
    
    const currentSection = document.querySelector('.active-section');
    const sectionHeader = currentSection.querySelector('.section-header');
    if (sectionHeader) {
        sectionHeader.insertAdjacentElement('afterend', errorDiv);
    } else {
        currentSection.insertBefore(errorDiv, currentSection.firstChild);
    }
    
    setTimeout(() => {
        if (errorDiv.parentNode) {
            errorDiv.remove();
        }
    }, 10000);
}

function bulkDownload() {
    if (selectedRecords.length === 0) {
        alert('Please select records to download.');
        return;
    }

    const confirmDownload = confirm(`Download ${selectedRecords.length} selected record${selectedRecords.length !== 1 ? 's' : ''}?`);
    if (!confirmDownload) return;

    fetch('/bulk_download', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ indices: selectedRecords })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.blob();
    })
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `selected_simulation_data_${new Date().toISOString().split('T')[0]}.xlsx`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        selectedRecords = [];
        updateBulkActionsVisibility();
        fetchRecords();
    })
    .catch(error => {
        console.error('Download error:', error);
        showErrorMessage('Error downloading selected records: ' + error.message);
    });
}

function bulkDelete() {
    if (selectedRecords.length === 0) {
        alert('Please select records to delete.');
        return;
    }

    const confirmDelete = confirm(`Are you sure you want to delete ${selectedRecords.length} selected record${selectedRecords.length !== 1 ? 's' : ''}? This action cannot be undone.`);
    if (!confirmDelete) return;

    fetch('/bulk_delete', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ indices: selectedRecords })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.error) {
            throw new Error(data.message || data.error);
        }
        
        alert(data.message);
        selectedRecords = [];
        updateBulkActionsVisibility();
        loadSummaryStats();
        fetchAllRecords().then(() => fetchRecords());
        showDataSavedIndicator();
    })
    .catch(error => {
        console.error('Delete error:', error);
        showErrorMessage('Error deleting selected records: ' + error.message);
    });
}

function setupDragAndDrop() {
    const uploadArea = document.querySelector('.upload-area');
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
    });

    ['dragenter', 'dragover'].forEach(eventName => {
        uploadArea.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, unhighlight, false);
    });

    uploadArea.addEventListener('drop', handleDrop, false);

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    function highlight(e) {
        uploadArea.classList.add('dragover');
    }

    function unhighlight(e) {
        uploadArea.classList.remove('dragover');
    }

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        
        if (files.length > 0) {
            document.getElementById('uploadFile').files = files;
            uploadFile();
        }
    }
}

function setupFormValidation() {
    const form = document.getElementById('sessionForm');
    
    form.addEventListener('submit', function(e) {
        const date = form.querySelector('input[name="Date"]').value;
        const participants = form.querySelector('input[name="Participants"]').value;
        const length = form.querySelector('input[name="Length_Hours"]').value;
        const branch = form.querySelector('select[name="Branch"]').value;
        const room = form.querySelector('select[name="Room"]').value;
        const department = form.querySelector('select[name="Department"]').value;
        
        if (!date || !participants || !length || !branch || !room || !department) {
            e.preventDefault();
            alert('Please fill in all required fields.');
            return;
        }

        if (selectedOperators.length === 0) {
            e.preventDefault();
            alert('Please select at least one operator.');
            return;
        }
        
        if (participants < 1) {
            e.preventDefault();
            alert('Number of participants must be at least 1.');
            return;
        }
        
        if (length <= 0) {
            e.preventDefault();
            alert('Session length must be greater than 0.');
            return;
        }
        
        const spUsed = form.querySelector('select[name="Simulated_Participants"]').value;
        const spNumber = form.querySelector('input[name="Num_Simulated_Participants"]');
        if (spUsed === 'No') {
            spNumber.value = '0';
        }
        
        setTimeout(() => {
            showDataSavedIndicator();
            fetchRecords();
        }, 500);
    });

    const updateForm = document.getElementById('updateForm');
    updateForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const recordId = formData.get('update_index');
        
        const date = formData.get('Date');
        const participants = formData.get('Participants');
        const length = formData.get('Length_Hours');
        const branch = formData.get('Branch');
        const room = formData.get('Room');
        const department = formData.get('Department');
        const operatorCount = document.querySelectorAll('#updateHiddenOperatorInputs input').length;
        
        if (!date || !participants || !length || !branch || !room || !department) {
            alert('Please fill in all required fields.');
            return;
        }
        if (operatorCount === 0) {
            alert('Please select at least one operator.');
            return;
        }
        if (parseInt(participants) < 1) {
            alert('Number of participants must be at least 1.');
            return;
        }
        if (parseFloat(length) <= 0) {
            alert('Session length must be greater than 0.');
            return;
        }
        
        const spUsed = formData.get('Simulated_Participants');
        if (spUsed === 'No') {
            formData.set('Num_Simulated_Participants', '0');
        }

        fetch('/update_record', {
            method: 'POST',
            body: formData,
        })
        .then(response => {
            if (response.redirected) {
                updateModal.hide();
                showDataSavedIndicator();
                loadSummaryStats();
                fetchAllRecords().then(() => fetchRecords());
            } else {
                return response.json();
            }
        })
        .then(data => {
            if (data && data.error) {
                showErrorMessage('Error updating record: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Update error:', error);
            showErrorMessage('Error updating record: ' + error.message);
        });
    });
}

window.addEventListener('resize', function() {
    setTimeout(function() {
        const charts = ['quickRoomChart', 'quickTimelineChart', 'roomUtilizationChart', 'learnerStatsChart', 'contactHoursChart', 'branchContactHoursChart', 'branchHoursBreakdownChart', 'departmentHoursBreakdownChart'];
        charts.forEach(chartId => {
            const element = document.getElementById(chartId);
            if (element && element.style.display !== 'none') {
                try {
                    Plotly.Plots.resize(chartId);
                } catch (error) {
                    console.log('Chart resize error:', error);
                }
            }
        });
    }, 100);
});

function formatDate(dateString) {
    if (!dateString) return '';
    return new Date(dateString + 'T00:00:00').toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
    });
}

function formatNumber(num) {
    if (num === null || num === undefined) return '0';
    return num.toLocaleString();
}
    </script>

</body>
</html>